Array.prototype.insert=function(a,b){this.splice(a,0,b)},String.prototype.strip=function(){return(this+"").replace(/^\s+|\s+$/g,"")};function uuid4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,a=>(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16))}function ev2k(a){const b=4135667516e-24/(2*Math.PI);return Math.sign(a)*Math.sqrt(2*5685629904369271e-47*Math.abs(a))/b}(function(a){a.fn.selectRegions=function(b){function c(a){let b={...a[0]},c={...a[a.length-1]};return b.end=b.start,b.start=j.start,c.start=c.end,c.end=j.end,a.insert(0,b),a.push(c),a}function d(a,b){if(!b)return a.style("display","none");b=`${b.toFixed(1)} eV`,a.style("display",null).style("font",m).style("opacity",.75).style("pointer-events","none");const c=a.selectAll("path").data([null]).join("path").attr("fill","yellow").attr("stroke","black"),d=a.selectAll("text").data([null]).join("text").call(a=>a.selectAll("tspan").data((b+"").split(/\n/)).join("tspan").attr("x",0).attr("y",(a,b)=>`${1.1*b}rem`).text(a=>a)),{x:e,y:f,width:g,height:i}=d.node().getBBox();d.attr("transform",`translate(${-g/2},${10-f})`),c.attr("d",`M${-g/2-5},5H-5l5,-5l5,5H${g/2+5}v${i+10}h-${g+10}z`)}function e(a){a.forEach(function(a,b){a.index=b});var b=v.selectAll("rect").data(a,function(a){return a.start});b.exit().transition().duration(100).attr("width",0).remove(),b.enter().append("rect").attr("x",function(a){return r(a.end)}).attr("width",0).attr("height",p).attr("y",0).on("mouseover",function(a){d3.select(`#region-${a.id}`).selectAll("td").style("background","rgb(255, 255, 0, 0.25)")}).on("mouseout",function(a){d3.select(`#region-${a.id}`).selectAll("td").style("background",null)}).on("mousemove",function(){let a=d3.mouse(this);w.attr("transform",`translate(${a[0]}, ${83})`).call(d,r.invert(a[0]))}).on("contextmenu",function(b){d3.event.preventDefault(),3<a.length&&(b.index<a.length-1?a[b.index+1].start=b.start:a[b.index-1].end=b.end,a.splice(b.index,1)),e(a)}).on("click",function(b){let c=d3.mouse(this),d={...b};d.id=k++,d.start=parseFloat(r.invert(c[0]).toFixed(1)),b.end=d.start,a.push(d),a.sort(function(c,a){return d3.ascending(c.start,a.start)}),e(a)}).attr("stroke","white").attr("stroke-width",1).attr("height",p).attr("y",0).merge(b).transition().duration(100).attr("fill",function(b){return 0<b.index&&b.index<a.length-1?"rgba(195, 20, 165, 0.45)":"rgba(0, 0, 0, 0.45)"}).attr("x",function(a){return r(a.start)}).attr("width",function(a){return r(a.end)-r(a.start)}),g(a.slice(1,a.length-1))}function f(a,b,c){"start"===b?l[a].end>c&&(l[a-1].end=c,l[a].start=c):"end"===b?c>l[a].start&&(l[a].end=c,l[a+1].start=c):l[a][b]=c,e(l)}function g(a){var b=["index","start","end","step","time","kspace"],c=d3.select("#table").selectAll("tr").data(a,a=>a.id);c.exit().remove();var d=c.enter().append("tr").attr("id",a=>`region-${a.id}`).merge(c),e=d.selectAll("td").data(function(a){return b.map(function(b){return{key:b,value:a[b],index:a.index}})});e.exit().remove(),e.enter().append("td").attr("contenteditable",a=>!["index","kspace"].includes(a.key)).on("focusout",function(a){let b=d3.select(this),c="kspace"==a.key?"true"===b.text().strip():parseFloat(b.text());[NaN,void 0].includes(c)&&(c=a.value,console.log(c,a.value),b.text(c)),f(a.index,a.key,c)}).on("click",function(a){"kspace"===a.key&&f(a.index,a.key,!a.value)}).on("keydown",function(){[13,32].includes(d3.event.keyCode)&&d3.event.preventDefault()}).merge(e).text(a=>a.value),i.text(JSON.stringify(a))}let h=d3.select(a(this)[0]),i=d3.select(b),j={start:-450,end:850},k=1,l=[{start:j.start,end:-200,step:1,time:1,kspace:!1,id:k++,index:0},{start:-200,end:700,step:1,time:1,kspace:!1,id:k++,index:1},{start:700,end:j.end,step:1,time:1,kspace:!1,id:k++,index:2}];try{l=c(JSON.parse(i.text()))}catch(a){}const m="10px Fira Code",n={top:0,right:0,bottom:50,left:0},o=400,p=.2*o,q=function(){var a=Math.sin,b=Math.exp;let c=[],d=0,e=0;for(let f=j.start,g=0;f<j.end;f++,g++)e=0>f?0:b(.005*-g)*p*a(.1*f),d=16+40/(1+b(-.25*f))+e,c.push({x:f,y:parseFloat(d.toFixed(2))});return c}(),r=d3.scaleLinear().range([0,o]).domain([j.start,j.end]),s=d3.scalePow().exponent(2).range([0,o]).domain([ev2k(j.start),ev2k(j.end)]),t=d3.axisBottom().scale(r).ticks(15).tickFormat(a=>a>=j.end-50?`${a} eV`:a),u=d3.axisBottom().scale(s).ticks(10).tickFormat(a=>0>a?"":14<=a?`${a} k`:a),v=h.append("svg").attr("viewBox",`-${n.left} -${n.top} ${o+n.left+n.right} ${p+n.top+n.bottom}`).attr("id","sel-canvas");v.append("g").attr("transform",`translate(0, ${p+1})`).style("font","10px Fira Code").call(t),v.append("g").attr("transform",`translate(0, ${p+n.bottom/2})`).style("font","10px Fira Code").call(u);const w=v.append("g");v.on("mouseleave",function(){w.call(d,null)}),v.append("path").datum(q).attr("fill","none").attr("stroke","black").attr("stroke-width",1.25).attr("d",d3.line().x(a=>r(a.x)).y(a=>p-a.y)),e(l)}})(jQuery),function(a){a.fn.showRegions=function(b){let c=d3.select(a(this)[0]);console.log(c,b,a(this));let d=c.append("table").attr("class","table table-sm regions"),e=d.append("thead"),f=d.append("tbody"),g=["index","start","end","step","time","kspace"];e.append("tr").selectAll("th").data(["#","Start","End","Step","Time","k-space"]).enter().append("th").text(a=>a);let h=f.selectAll("tr").data(b,a=>a.id).enter().append("tr").attr("id",a=>`region-${a.id}`);h.selectAll("td").data(function(a){return g.map(function(b){return{key:b,value:a[b],index:a.index}})}).enter().append("td").text(a=>a.value)}}(jQuery);